<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>タイムスタンプ作成ツール(プレビュー版)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin: 24px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="text"], textarea { padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
    input[type="text"] { flex: 1; min-width: 280px; }
    button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    #playerWrap { width: 720px; max-width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
    #player, #fileMedia { width: 100%; height: 100%; }
    #fileMedia { display: none; background: #000; object-fit: contain; }
    .hidden { display: none !important; }
    .time { font-variant-numeric: tabular-nums; font-weight: 700; }
    .pill { background:#f5f5f5; border-radius:999px; padding:4px 8px; }
    ul { list-style: none; padding: 0; margin: 0; }
    li.stamp { display: grid; grid-template-columns: auto 1fr auto; gap: 8px; align-items: center; padding: 8px; border: 1px solid #eee; border-radius: 10px; }
    .title { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; }
    .stack { display: grid; gap: 8px; }
    .grid { display: grid; gap: 20px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    /* タイムスタンプ右側に一覧(プレビュー)を並べる */
    .tsgrid { display: grid; gap: 12px; grid-template-columns: 1fr; align-items: start; }
    @media (min-width: 700px) { .tsgrid { grid-template-columns: 1fr 1fr; } }
    .tsgrid .previewArea { display: grid; gap: 8px; }
    #list { margin: 0; display: flex; flex-direction: column; gap: 8px; max-height: 60vh; overflow-y: auto; overflow-x: hidden; }
    textarea { width: 100%; height: 140px; }
    .stack > h2 { margin: 0 0 6px; }
  </style>
</head>
<body>
  <h1>タイムスタンプ作成ツール(プレビュー版)</h1>

  <div class="stack" style="margin-bottom:16px">
    <div class="row" id="modeRow">
      <label><input type="radio" name="mode" value="youtube" checked> YouTube</label>
      <label><input type="radio" name="mode" value="file"> ファイル（mp4/mp3/wav）</label>
      <span id="fileName" class="pill hidden"></span>
      <input id="fileInput" type="file" accept="video/mp4,audio/mpeg,audio/wav" class="hidden" />
    </div>
    <div class="row" id="ytRow" data-fixed="1">
      <input id="videoInput" type="text" placeholder="YouTubeのURL または 動画ID" />
      <button id="loadBtn" type="button" class="primary" onclick="window._handleLoad && window._handleLoad()">読み込み</button>
    </div>
    <div class="row">
      <button id="toggleBtn" type="button" disabled>再生</button>
      <button id="addBtn" type="button" disabled>現在位置でタイムスタンプ追加</button>
      <span id="status" class="pill">未ロード</span>
    </div>
    <div class="row">
      <span>現在位置: <strong id="currentTime" class="time">00:00</strong></span>
    </div>
  </div>

  <div class="grid">
    <div class="stack">
      <div id="playerWrap">
        <div id="player"></div>
        <video id="fileMedia" playsinline preload="metadata"></video>
      </div>
      <div class="hint">スペースキー: 再生/一時停止、Enter: 現在位置を追加</div>
    </div>

    <div class="stack">
      <div class="tsgrid">
        <div class="listArea">
          <ul id="list"></ul>
        </div>
        <div class="previewArea">
          <div class="row">
            <button id="copyBtn" type="button" disabled>一覧をコピー</button>
            <button id="clearBtn" type="button" disabled>すべて削除</button>
          </div>
          <textarea id="preview" readonly placeholder="ここにコピー内容が表示されます"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // ====== 状態 ======
    let mode = 'youtube'; // 'youtube' | 'file'
    let player = null;    // YouTube
    let isYTReady = false;
    let pendingVideoId = '';

    let stamps = [];      // { time:number, label:string }
    let useHMS = false;   // mm:ss / hh:mm:ss 切替

    const fileMedia = document.getElementById('fileMedia');
    let isFileReady = false;
    let fileReadyURL = null;

    // ====== ユーティリティ ======
    const $ = (sel) => document.querySelector(sel);
    function statusMsg(msg){ const s=$('#status'); if (s) s.textContent = msg; }

    function fmt(sec){ if(!isFinite(sec)) return '--:--'; sec=Math.max(0,Math.floor(sec)); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; const mm=String(m).padStart(2,'0'); const ss=String(s).padStart(2,'0'); return useHMS? `${String(h).padStart(2,'0')}:${mm}:${ss}` : `${mm}:${ss}`; }

    function getCurrentTime(){ return mode==='youtube' ? (player && player.getCurrentTime? player.getCurrentTime():0) : (fileMedia && fileMedia.currentTime||0); }

    function updateFormatMode(){ try{ const dur = mode==='youtube' ? (player && player.getDuration? player.getDuration():0) : (fileMedia && isFinite(fileMedia.duration) ? fileMedia.duration : 0); useHMS = dur >= 3600; }catch(_){} }

    function setControlsEnabled(ready){ const tgl=$('#toggleBtn'); if(tgl) tgl.disabled=!ready; $('#addBtn').disabled=!ready; $('#copyBtn').disabled=stamps.length===0; const clr=$('#clearBtn'); if (clr) clr.disabled=stamps.length===0; }

    function rebuildList(){ stamps = stamps.map(x=> typeof x==='number'? {time:x,label:''}:x).sort((a,b)=>a.time-b.time); const ul=$('#list'); ul.innerHTML=''; for(const item of stamps){ const li=document.createElement('li'); li.className='stamp'; const time=document.createElement('code'); time.className='time'; time.textContent=fmt(item.time); const title=document.createElement('input'); title.className='title'; title.value=item.label||''; title.placeholder='（任意）見出し'; title.addEventListener('input',()=>{ item.label=title.value; buildPreview(); }); const del=document.createElement('button'); del.textContent='削除'; del.addEventListener('click',()=>{ stamps=stamps.filter(x=>x!==item); rebuildList(); buildPreview(); }); li.append(time,title,del); ul.appendChild(li);} setControlsEnabled(mode==='youtube'? isYTReady: isFileReady); buildPreview(); }

    function buildPreview(){ const txt=stamps.slice().sort((a,b)=>a.time-b.time).map(x=>`${fmt(x.time)}${x.label? ' '+x.label:''}`).join('
'); $('#preview').value = txt; }

    // ====== プレイヤー描画 ======
    function loopUpdateCurrentTime(){ const t=getCurrentTime(); $('#currentTime').textContent = isFinite(t)? fmt(t) : '00:00'; requestAnimationFrame(loopUpdateCurrentTime); }

    // ====== YouTube IFrame API 読み込み ======
    (function loadYT(){ const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; tag.async=true; tag.onerror=()=>statusMsg('YouTube APIの読み込みに失敗しました'); document.head.appendChild(tag); setTimeout(()=>{ if(!(window.YT&&window.YT.Player)) statusMsg('YouTube APIが読み込まれていません'); }, 3500); })();
    // グローバル経由のフォールバック呼び出し
    window._handleLoad = handleLoad;

    window.onYouTubeIframeAPIReady = function(){
      player = new YT.Player('player', {
        height:'100%', width:'100%', videoId:'', host:'https://www.youtube-nocookie.com',
        playerVars:{ playsinline:1, origin: location.origin, enablejsapi:1 },
        events:{ onReady, onStateChange, onError }
      });
    };

    function onReady(){ isYTReady = true; statusMsg('未ロード'); if (pendingVideoId){ try{ player.cueVideoById(pendingVideoId); }catch(_){} pendingVideoId=''; } updateFormatMode(); loopUpdateCurrentTime(); setControlsEnabled(mode==='youtube'? isYTReady: isFileReady); }
    function onStateChange(e){ if(!e) return; if(e.data===YT.PlayerState.CUED){ updateFormatMode(); if(mode==='youtube') setControlsEnabled(true); try{ const d=player.getVideoData&&player.getVideoData(); const vid=d&&(d.video_id||d.videoId)||''; statusMsg(vid? '読み込み完了: '+vid : '読み込み完了'); }catch(_){ statusMsg('読み込み完了'); } const t=$('#toggleBtn'); if(t) t.textContent='再生'; } if(e.data===YT.PlayerState.PLAYING){ const t=$('#toggleBtn'); if(t) t.textContent='一時停止'; } if(e.data===YT.PlayerState.PAUSED || e.data===YT.PlayerState.ENDED){ const t=$('#toggleBtn'); if(t) t.textContent='再生'; } }
    function onError(e){ statusMsg('エラー: '+(e&&e.data)); }

    function ensureCueOrLoad(id, phase){ try{ const st=player&&player.getPlayerState? player.getPlayerState():undefined; if(st===YT.PlayerState.CUED||st===YT.PlayerState.PAUSED||st===YT.PlayerState.PLAYING) return; }catch(_){} if(phase===0){ try{ player.loadVideoById(id);}catch(_){} setTimeout(()=>{ try{ player.pauseVideo(); }catch(_){} },500); setTimeout(()=>ensureCueOrLoad(id,1),1400);} else if(phase===1){ try{ player.cueVideoById(id);}catch(_){} } }

    // ====== ファイルモード ======
    fileMedia.addEventListener('loadedmetadata', ()=>{ isFileReady=true; updateFormatMode(); if(mode==='file'){ setControlsEnabled(true); statusMsg('読み込み完了: '+($('#fileName').textContent||'ファイル')); $('#toggleBtn').textContent='再生'; }});
    fileMedia.addEventListener('play', ()=>{ if(mode==='file') $('#toggleBtn').textContent='一時停止'; });
    fileMedia.addEventListener('pause', ()=>{ if(mode==='file') $('#toggleBtn').textContent='再生'; });
    fileMedia.addEventListener('ended', ()=>{ if(mode==='file') $('#toggleBtn').textContent='再生'; });

    // ====== モード切替 ======
    function setMode(newMode){ mode=newMode; const ytRow=$('#ytRow'); const fileName=$('#fileName'); const iframe=$('#playerWrap iframe'); if(mode==='youtube'){ ytRow.classList.remove('hidden'); fileName.classList.add('hidden'); if (iframe) iframe.style.display=''; fileMedia.style.display='none'; setControlsEnabled(isYTReady); statusMsg('未ロード'); } else { ytRow.classList.add('hidden'); fileName.classList.remove('hidden'); if (iframe) iframe.style.display='none'; fileMedia.style.display=''; setControlsEnabled(isFileReady); statusMsg('ファイル未選択'); } }
    Array.from(document.getElementsByName('mode')).forEach(r=> r.addEventListener('change', e=> setMode(e.target.value)));

    // ====== ボタン類 ======
    function handleLoad(){
      try{ console.log('[UI] handleLoad clicked, mode=', mode); }catch(_){ }
 if(mode!=='youtube'){ const fi=$('#fileInput'); if(fi) fi.click(); return; } const raw=$('#videoInput').value.trim(); const id=parseVideoId(raw); if(!id){ alert('URLまたは動画IDを入力してください'); return; } setControlsEnabled(false); statusMsg('読み込み中…'); if(isYTReady){ try{ player.cueVideoById(id);}catch(_){}} else { pendingVideoId=id; } setTimeout(()=>{ try{ ensureCueOrLoad(id,0);}catch(_){ } },1200); }

    const lb=$('#loadBtn'); if(lb){ lb.addEventListener('click', handleLoad); lb.addEventListener('mousedown', handleLoad); lb.addEventListener('touchstart', handleLoad, {passive:true}); }
    document.addEventListener('click', ev=>{ if(ev.target && ev.target.id==='loadBtn') handleLoad(); });
    const vi=$('#videoInput'); if(vi) vi.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handleLoad(); }});

    $('#toggleBtn').addEventListener('click', ()=>{ if(mode==='youtube'){ const st=player&&player.getPlayerState? player.getPlayerState():undefined; if(st===YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo(); } else { if(fileMedia.paused) fileMedia.play(); else fileMedia.pause(); } });
    $('#addBtn').addEventListener('click', ()=>{ const t=getCurrentTime(); if(!isFinite(t)) return; stamps.push({time:t,label:''}); rebuildList(); });
    $('#copyBtn').addEventListener('click', async ()=>{ const txt=$('#preview').value; try{ await navigator.clipboard.writeText(txt); statusMsg('コピーしました'); }catch(_){ const ta=$('#preview'); ta.focus(); ta.select(); document.getSelection().removeAllRanges(); statusMsg('コピーに失敗。手動でCtrl/Cmd+Cでコピーしてください'); }});
    $('#clearBtn').addEventListener('click', ()=>{ if(!stamps.length) return; if(!confirm('すべてのタイムスタンプを削除します。よろしいですか？')) return; stamps=[]; rebuildList(); });

    window.addEventListener('keydown', (e)=>{ const tag=(e.target.tagName||'').toLowerCase(); if(tag==='input'||tag==='textarea') return; if(e.code==='Space'){ e.preventDefault(); if(mode==='youtube'){ const st=player.getPlayerState(); if(st===YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo(); } else { if(fileMedia.paused) fileMedia.play(); else fileMedia.pause(); } } else if(e.key==='Enter'){ const t=getCurrentTime(); if(!isFinite(t)) return; stamps.push({time:t,label:''}); rebuildList(); } });

    function parseVideoId(input){ if(!input) return ''; const raw=input.trim(); if(/^[a-zA-Z0-9_-]{10,}$/u.test(raw) && !raw.includes('http')) return raw; try{ const u=new URL(raw); const host=u.hostname.replace(/^www\./,''); const segs=u.pathname.split('/').filter(Boolean); if(host.includes('youtu.be')&&segs[0]) return segs[0]; const v=u.searchParams.get('v'); if(v) return v; if(segs[0]==='shorts'&&segs[1]) return segs[1]; if(segs[0]==='embed'&&segs[1]) return segs[1]; if(segs.length) return segs[segs.length-1]; }catch(_){ return raw; } return raw; }

    // 初期化
    setMode('youtube');
  })();
</script>
</body>
</html>
