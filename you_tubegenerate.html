<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>タイムスタンプ作成ツール(プレビュー版)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin: 24px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="text"], textarea { padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
    input[type="text"] { flex: 1; min-width: 280px; }
    button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    #playerWrap { width: 720px; max-width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
    #player, #fileMedia { width: 100%; height: 100%; }
    #fileMedia { display: none; background: #000; object-fit: contain; }
    .hidden { display: none !important; }
    .time { font-variant-numeric: tabular-nums; font-weight: 700; }
    .pill { background:#f5f5f5; border-radius:999px; padding:4px 8px; }
    ul { list-style: none; padding: 0; margin: 0; }
    li.stamp { display: grid; grid-template-columns: auto 1fr auto; gap: 8px; align-items: center; padding: 8px; border: 1px solid #eee; border-radius: 10px; }
    .title { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; }
    .stack { display: grid; gap: 8px; }
    .grid { display: grid; gap: 20px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    /* タイムスタンプ右側に一覧(プレビュー)を並べる */
    .tsgrid { display: grid; gap: 12px; grid-template-columns: 1fr; align-items: start; }
    @media (min-width: 700px) { .tsgrid { grid-template-columns: 1fr 1fr; } }
    .tsgrid .previewArea { display: grid; gap: 8px; }
    #list { margin: 0; display: flex; flex-direction: column; gap: 8px; max-height: 60vh; overflow-y: auto; overflow-x: hidden; }
    textarea { width: 100%; height: 140px; }
    .stack > h2 { margin: 0 0 6px; }
  </style>
</head>
<body>
  <h1>タイムスタンプ作成ツール(プレビュー版)</h1>

  <div class="stack" style="margin-bottom:16px">
    <div class="row" id="modeRow">
      <label><input type="radio" name="mode" value="youtube" checked> YouTube</label>
      <label><input type="radio" name="mode" value="file"> ファイル（mp4/mp3/wav）</label>
      <span id="fileName" class="pill hidden"></span>
      <input id="fileInput" type="file" accept="video/mp4,audio/mpeg,audio/wav" class="hidden" />
    </div>
    <div class="row" id="ytRow">
      <input id="videoInput" type="text" placeholder="YouTubeのURL または 動画ID" />
      <button id="loadBtn">読み込み</button>
    </div>
    <div class="row">
      <button id="toggleBtn" disabled>再生</button>
      <button id="addBtn" disabled>現在位置でタイムスタンプ追加</button>
      <span id="status" class="pill">未ロード</span>
    </div>
    <div class="row">
      <span>現在位置: <strong id="currentTime" class="time">00:00</strong></span>
    </div>
  </div>

  <div class="grid">
    <div class="stack">
      <div id="playerWrap">
        <div id="player"></div>
        <video id="fileMedia" playsinline preload="metadata"></video>
      </div>
      <div class="hint">スペースキー: 再生/一時停止、Enter: 現在位置を追加</div>
    </div>

    <div class="stack">
      <div class="tsgrid">
        <div class="listArea">
          <ul id="list"></ul>
        </div>
        <div class="previewArea">
          <div class="row">
            <button id="copyBtn" disabled>一覧をコピー</button>
            <button id="clearBtn" disabled>すべて削除</button>
          </div>
          <textarea id="preview" readonly placeholder="ここにコピー内容が表示されます"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- モード管理 ---
    let mode = 'youtube'; // 'youtube' | 'file'

    function setMode(newMode){
      mode = newMode;
      const ytRow = document.getElementById('ytRow');
      const fileName = document.getElementById('fileName');
      const fm = document.getElementById('fileMedia');
      if (mode === 'youtube'){
        ytRow.classList.remove('hidden');
        fileName.classList.add('hidden');
        fm.style.display = 'none';
        const iframe = document.querySelector('#playerWrap iframe');
        if (iframe) iframe.style.display = '';
        setControlsEnabled(isYTReady);
        document.getElementById('status').textContent = '未ロード';
      } else {
        ytRow.classList.add('hidden');
        fileName.classList.remove('hidden');
        fm.style.display = '';
        const iframe = document.querySelector('#playerWrap iframe');
        if (iframe) iframe.style.display = 'none';
        setControlsEnabled(isFileReady);
        document.getElementById('status').textContent = 'ファイル未選択';
      }
    }

    document.getElementsByName('mode').forEach(r => r.addEventListener('change', (e)=>{
      setMode(e.target.value);
    }));

    // --- YouTube IFrame API ロード（堅牢化） ---
    (function loadYT(){
      const tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      tag.async = true;
      tag.onerror = () => { try { document.getElementById('status').textContent = 'YouTube APIの読み込みに失敗しました'; } catch(_) {} };
      document.head.appendChild(tag);
      setTimeout(() => {
        if (!(window.YT && window.YT.Player)) {
          try { document.getElementById('status').textContent = 'YouTube APIが読み込まれていません（拡張機能やネットワーク設定をご確認ください）'; } catch(_) {}
        }
      }, 3500);
    })();

    let player = null;     // YT
    let isYTReady = false;
    let pendingVideoId = '';

    let fileReadyURL = null; // blob URL cleanup
    const fileMedia = document.getElementById('fileMedia');
    let isFileReady = false;

    let stamps = []; // { time:number, label:string }
    let useHMS = false; // 総再生時間でフォーマット切替（現在のモードのメディア長で決定）

    // IFrame API callback (global)
    window.onYouTubeIframeAPIReady = function() {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: '',
        host: 'https://www.youtube-nocookie.com',
        playerVars: { playsinline: 1, origin: location.origin, enablejsapi: 1 },
        events: { 'onReady': onReady, 'onStateChange': onStateChange, 'onError': onError }
      });
    };

    function onReady() {
      isYTReady = true;
      if (pendingVideoId) { try { player.cueVideoById(pendingVideoId); } catch(_) {} pendingVideoId = ''; }
      updateFormatMode();
      loopUpdateCurrentTime();
      setControlsEnabled(mode === 'youtube' ? isYTReady : isFileReady);
    }

    function onStateChange(e) {
      if (!e) return;
      if (e.data === YT.PlayerState.CUED) {
        updateFormatMode();
        if (mode === 'youtube') setControlsEnabled(true);
        try {
          const data = player.getVideoData && player.getVideoData();
          const vid = data && (data.video_id || data.videoId) || '';
          document.getElementById('status').textContent = vid ? ('読み込み完了: ' + vid) : '読み込み完了';
        } catch(_) {
          document.getElementById('status').textContent = '読み込み完了';
        }
        const t = document.getElementById('toggleBtn'); if (t) t.textContent = '再生';
      }
      if (e.data === YT.PlayerState.PLAYING) {
        if (mode === 'youtube') { const t = document.getElementById('toggleBtn'); if (t) t.textContent = '一時停止'; }
      }
      if (e.data === YT.PlayerState.PAUSED || e.data === YT.PlayerState.ENDED) {
        if (mode === 'youtube') { const t = document.getElementById('toggleBtn'); if (t) t.textContent = '再生'; }
      }
    }

    function onError(e) {
      try {
        console.error('YouTube IFrame API error:', e);
        var code = e && e.data;
        document.getElementById('status').textContent = 'エラー: ' + code;
      } catch(_) {}
    }

    // --- File media events ---
    fileMedia.addEventListener('loadedmetadata', ()=>{
      isFileReady = true;
      updateFormatMode();
      if (mode === 'file') {
        setControlsEnabled(true);
        document.getElementById('status').textContent = '読み込み完了: ' + (document.getElementById('fileName').textContent || 'ファイル');
        document.getElementById('toggleBtn').textContent = '再生';
      }
    });
    fileMedia.addEventListener('play', ()=>{ if (mode==='file') document.getElementById('toggleBtn').textContent='一時停止'; });
    fileMedia.addEventListener('pause', ()=>{ if (mode==='file') document.getElementById('toggleBtn').textContent='再生'; });
    fileMedia.addEventListener('ended', ()=>{ if (mode==='file') document.getElementById('toggleBtn').textContent='再生'; });

    function updateFormatMode() {
      let dur = 0;
      try {
        if (mode === 'youtube' && player && typeof player.getDuration === 'function') dur = player.getDuration();
        if (mode === 'file' && fileMedia && isFinite(fileMedia.duration)) dur = fileMedia.duration;
      } catch {}
      useHMS = dur >= 3600;
    }

    function getCurrentTime(){
      if (mode === 'youtube' && player && typeof player.getCurrentTime === 'function') return player.getCurrentTime();
      if (mode === 'file' && fileMedia) return fileMedia.currentTime || 0;
      return 0;
    }

    function playMedia(){ if (mode==='youtube') player && player.playVideo(); else fileMedia && fileMedia.play(); }
    function pauseMedia(){ if (mode==='youtube') player && player.pauseVideo(); else fileMedia && fileMedia.pause(); }

    function loopUpdateCurrentTime() {
      const t = getCurrentTime();
      document.getElementById('currentTime').textContent = isFinite(t) ? fmt(t) : '00:00';
      requestAnimationFrame(loopUpdateCurrentTime);
    }

    function setControlsEnabled(ready) {
      const tgl = document.getElementById('toggleBtn'); if (tgl) tgl.disabled = !ready;
      document.getElementById('addBtn').disabled = !ready;
      document.getElementById('copyBtn').disabled = stamps.length === 0;
      const clr = document.getElementById('clearBtn'); if (clr) clr.disabled = stamps.length === 0;
    }

    function fmt(sec) {
      if (!isFinite(sec)) return '--:--';
      sec = Math.max(0, Math.floor(sec));
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      const mm = String(m).padStart(2,'0');
      const ss = String(s).padStart(2,'0');
      if (useHMS) { const hh = String(h).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
      return `${mm}:${ss}`;
    }

    function rebuildList() {
      stamps = stamps.map(x => (typeof x === 'number' ? { time: x, label: '' } : x));
      const ul = document.getElementById('list');
      ul.innerHTML = '';
      stamps.sort((a,b)=>a.time-b.time);
      for (const item of stamps) {
        const li = document.createElement('li');
        li.className = 'stamp';
        const time = document.createElement('code');
        time.className = 'time';
        time.textContent = fmt(item.time);
        const title = document.createElement('input');
        title.className = 'title';
        title.value = item.label || '';
        title.placeholder = '（任意）見出し';
        title.addEventListener('input', () => { item.label = title.value; buildPreview(); });
        const del = document.createElement('button');
        del.textContent = '削除';
        del.addEventListener('click', () => { stamps = stamps.filter(x=>x!==item); rebuildList(); buildPreview(); });
        li.append(time, title, del);
        ul.appendChild(li);
      }
      document.getElementById('copyBtn').disabled = stamps.length === 0;
      const clr = document.getElementById('clearBtn'); if (clr) clr.disabled = stamps.length === 0;
      buildPreview();
    }

    function buildPreview() {
      const lines = stamps
        .sort((a,b)=>a.time-b.time)
        .map(x => `${fmt(x.time)}${x.label ? ' ' + x.label : ''}`);
      document.getElementById('preview').value = lines.join('\n');
    }

    function addCurrent() {
      const t = getCurrentTime();
      if (!isFinite(t)) return;
      stamps.push({ time: t, label: '' });
      rebuildList();
    }

    // --- UI ハンドラ ---
    document.getElementById('loadBtn').addEventListener('click', () => {
      if (mode === 'youtube') {
        const input = document.getElementById('videoInput').value.trim();
        const id = parseVideoId(input);
        if (!id) { alert('URLまたは動画IDを入力してください'); return; }
        if (isYTReady) { try { player.cueVideoById(id); } catch(_) {} } else { pendingVideoId = id; }
        setControlsEnabled(false);
        document.getElementById('status').textContent = '読み込み中…';
        setTimeout(() => { try { ensureCueOrLoad(id, 0); } catch(_) {} }, 1200);
      } else {
        document.getElementById('fileInput').click();
      }
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      if (!/\.(mp4|mp3|wav)$/i.test(f.name)) {
        alert('対応形式は mp4 / mp3 / wav です');
        return;
      }
      const fm = document.getElementById('fileMedia');
      if (fileReadyURL) { URL.revokeObjectURL(fileReadyURL); fileReadyURL = null; }
      fileReadyURL = URL.createObjectURL(f);
      fm.src = fileReadyURL;
      fm.load();
      document.getElementById('fileName').textContent = f.name;
      document.getElementById('status').textContent = '読み込み中…';
    });

    document.getElementById('toggleBtn').addEventListener('click', () => {
      const st = mode==='youtube' && player && player.getPlayerState ? player.getPlayerState() : (fileMedia && (fileMedia.paused? 'PAUSED' : 'PLAYING'));
      if (mode==='youtube') {
        if (st === YT.PlayerState.PLAYING) player.pauseVideo(); else player.playVideo();
      } else {
        if (fileMedia.paused) fileMedia.play(); else fileMedia.pause();
      }
    });

    document.getElementById('addBtn').addEventListener('click', addCurrent);

    document.getElementById('copyBtn').addEventListener('click', async () => {
      const txt = document.getElementById('preview').value;
      try { await navigator.clipboard.writeText(txt); document.getElementById('status').textContent = 'コピーしました'; }
      catch (e) {
        const ta = document.getElementById('preview'); ta.focus(); ta.select(); document.getSelection().removeAllRanges();
        document.getElementById('status').textContent = 'コピーに失敗。手動でCtrl/Cmd+Cでコピーしてください';
      }
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      if (!stamps.length) return;
      if (!confirm('すべてのタイムスタンプを削除します。よろしいですか？')) return;
      stamps = []; rebuildList();
    });

    // キーボードショートカット
    window.addEventListener('keydown', (e) => {
      const tag = (e.target.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea') return; // 入力中は無効
      if (e.code === 'Space') { e.preventDefault(); const st = mode==='youtube' ? player.getPlayerState() : (fileMedia.paused? 'PAUSED':'PLAYING'); if (st === YT.PlayerState.PLAYING || st==='PLAYING') pauseMedia(); else playMedia(); }
      else if (e.key === 'Enter') { addCurrent(); }
    });

    function parseVideoId(input) {
      if (!input) return '';
      const raw = input.trim();
      if (/^[a-zA-Z0-9_-]{10,}$/u.test(raw) && !raw.includes('http')) return raw;
      try {
        const u = new URL(raw);
        const host = u.hostname.replace(/^www\./, '');
        const segs = u.pathname.split('/').filter(Boolean);
        if (host.includes('youtu.be') && segs[0]) return segs[0];
        const v = u.searchParams.get('v'); if (v) return v;
        if (segs[0] === 'shorts' && segs[1]) return segs[1];
        if (segs[0] === 'embed' && segs[1]) return segs[1];
        if (segs.length) return segs[segs.length - 1];
      } catch(_) { return raw; }
      return raw;
    }

    // フォールバック: CUEDが来ない場合の対処（YouTube用）
    function ensureCueOrLoad(id, phase) {
      try {
        const st = player && player.getPlayerState ? player.getPlayerState() : undefined;
        if (st === YT.PlayerState.CUED || st === YT.PlayerState.PAUSED || st === YT.PlayerState.PLAYING) return;
      } catch(_) {}
      if (phase === 0) {
        try { player.loadVideoById(id); } catch(_) {}
        setTimeout(() => { try { player.pauseVideo(); } catch(_) {} }, 500);
        setTimeout(() => ensureCueOrLoad(id, 1), 1400);
      } else if (phase === 1) { try { player.cueVideoById(id); } catch(_) {} }
    }

    // 初期モード適用
    setMode('youtube');
  </script>
</body>
</html>
