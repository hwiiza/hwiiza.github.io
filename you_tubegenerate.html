<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>タイムスタンプ作成ツール(プレビュー版)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    body { margin: 24px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="text"], textarea { padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
    input[type="text"] { flex: 1; min-width: 280px; }
    button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    #playerWrap { width: 720px; max-width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
    #player, #fileMedia { width: 100%; height: 100%; }
    #fileMedia { display: none; background: #000; object-fit: contain; }
    .hidden { display: none !important; }
    .time { font-variant-numeric: tabular-nums; font-weight: 700; }
    .pill { background:#f5f5f5; border-radius:999px; padding:4px 8px; }
    ul { list-style: none; padding: 0; margin: 0; }
    li.stamp { display: grid; grid-template-columns: auto 1fr auto; gap: 8px; align-items: center; padding: 8px; border: 1px solid #eee; border-radius: 10px; }
    .title { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; }
    .stack { display: grid; gap: 8px; }
    .grid { display: grid; gap: 20px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    /* タイムスタンプ右側に一覧(プレビュー)を並べる */
    .tsgrid { display: grid; gap: 12px; grid-template-columns: 1fr; align-items: start; }
    @media (min-width: 700px) { .tsgrid { grid-template-columns: 1fr 1fr; } }
    .tsgrid .previewArea { display: grid; gap: 8px; }
    #list { margin: 0; display: flex; flex-direction: column; gap: 8px; max-height: 60vh; overflow-y: auto; overflow-x: hidden; }
    textarea { width: 100%; height: 140px; }
    .stack > h2 { margin: 0 0 6px; }
  </style>
</head>
<body>
  <h1>タイムスタンプ作成ツール(プレビュー版)</h1>

  <div class="stack" style="margin-bottom:16px">
    <div class="row" id="modeRow">
      <label><input type="radio" name="mode" value="youtube" checked> YouTube</label>
      <label><input type="radio" name="mode" value="file"> ファイル（mp4/mp3/wav）</label>
      <span id="fileName" class="pill hidden"></span>
      <input id="fileInput" type="file" accept="video/mp4,audio/mpeg,audio/wav" class="hidden" />
    </div>
    <div class="row" id="ytRow" data-fixed="1">
      <input id="videoInput" type="text" placeholder="YouTubeのURL または 動画ID" />
      <button id="loadBtn" type="button" class="primary" onclick="window._handleLoad && window._handleLoad()">読み込み</button>
    </div>
    <div class="row">
      <button id="toggleBtn" type="button" disabled>再生</button>
      <button id="addBtn" type="button" disabled>現在位置でタイムスタンプ追加</button>
      <span id="status" class="pill">未ロード</span>
    </div>
    <div class="row">
      <span>現在位置: <strong id="currentTime" class="time">00:00</strong></span>
    </div>
  </div>

  <div class="grid">
    <div class="stack">
      <div id="playerWrap">
        <div id="player"></div>
        <video id="fileMedia" playsinline preload="metadata"></video>
      </div>
      <div class="hint">スペースキー: 再生/一時停止、Enter: 現在位置を追加</div>
    </div>

    <div class="stack">
      <div class="tsgrid">
        <div class="listArea">
          <ul id="list"></ul>
        </div>
        <div class="previewArea">
          <div class="row">
            <button id="copyBtn" type="button" disabled>一覧をコピー</button>
            <button id="clearBtn" type="button" disabled>すべて削除</button>
          </div>
          <textarea id="preview" readonly placeholder="ここにコピー内容が表示されます"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
(function(){
  'use strict';
  // ===== State =====
  var mode = 'youtube';
  var player = null; // YT player
  var isYTReady = false;
  var pendingVideoId = '';

  var stamps = []; // { time:number, label:string }
  var useHMS = false; // mm:ss vs hh:mm:ss

  var fileMedia = document.getElementById('fileMedia');
  var isFileReady = false;
  var fileReadyURL = null;

  // ===== Helpers =====
  function $(sel){ return document.querySelector(sel); }
  function statusMsg(msg){ try{ var s=$('#status'); if(s) s.textContent = String(msg); }catch(e){} }

  function fmt(sec){
    if (!isFinite(sec)) return '--:--';
    sec = Math.max(0, Math.floor(sec));
    var h = Math.floor(sec/3600);
    var m = Math.floor((sec%3600)/60);
    var s = sec%60;
    var mm = String(m).padStart(2,'0');
    var ss = String(s).padStart(2,'0');
    if (useHMS){ var hh = String(h).padStart(2,'0'); return hh+':'+mm+':'+ss; }
    return mm+':'+ss;
  }

  function getCurrentTime(){
    if (mode==='youtube') return (player && player.getCurrentTime) ? player.getCurrentTime() : 0;
    return (fileMedia && fileMedia.currentTime) ? fileMedia.currentTime : 0;
  }

  function updateFormatMode(){
    try{
      var dur = 0;
      if (mode==='youtube' && player && player.getDuration) dur = player.getDuration();
      if (mode==='file' && fileMedia && isFinite(fileMedia.duration)) dur = fileMedia.duration;
      useHMS = dur >= 3600;
    }catch(e){}
  }

  function setControlsEnabled(ready){
    var tgl = $('#toggleBtn'); if (tgl) tgl.disabled = !ready;
    var add = $('#addBtn'); if (add) add.disabled = !ready;
    var copy = $('#copyBtn'); if (copy) copy.disabled = (stamps.length===0);
    var clr = $('#clearBtn'); if (clr) clr.disabled = (stamps.length===0);
  }

  function rebuildList(){
    stamps = stamps.map(function(x){ return (typeof x==='number')? {time:x,label:''}: x; });
    stamps.sort(function(a,b){ return a.time-b.time; });
    var ul = $('#list');
    if (!ul) return;
    ul.innerHTML='';
    for (var i=0;i<stamps.length;i++){
      (function(item){
        var li = document.createElement('li'); li.className='stamp';
        var time = document.createElement('code'); time.className='time'; time.textContent = fmt(item.time);
        var title = document.createElement('input'); title.className='title'; title.value=item.label||''; title.placeholder='（任意）見出し';
        title.addEventListener('input', function(){ item.label = title.value; buildPreview(); });
        var del = document.createElement('button'); del.textContent='削除';
        del.addEventListener('click', function(){ stamps = stamps.filter(function(x){ return x!==item; }); rebuildList(); buildPreview(); });
        li.appendChild(time); li.appendChild(title); li.appendChild(del);
        ul.appendChild(li);
      })(stamps[i]);
    }
    setControlsEnabled(mode==='youtube'? isYTReady : isFileReady);
    buildPreview();
  }

  function buildPreview(){
    var lines = stamps.slice().sort(function(a,b){return a.time-b.time;}).map(function(x){ return fmt(x.time) + (x.label? ' '+x.label : ''); });
    var ta = $('#preview'); if (ta) ta.value = lines.join('
');
  }

  function loopUpdateCurrentTime(){
    try{
      var t = getCurrentTime();
      var el = $('#currentTime'); if (el) el.textContent = isFinite(t)? fmt(t) : '00:00';
    }catch(e){}
    requestAnimationFrame(loopUpdateCurrentTime);
  }

  // ===== YouTube IFrame API =====
  (function loadYT(){
    var tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    tag.async = true;
    tag.onerror = function(){ statusMsg('YouTube APIの読み込みに失敗しました'); };
    document.head.appendChild(tag);
    setTimeout(function(){ if (!(window.YT && window.YT.Player)) statusMsg('YouTube APIが読み込まれていません'); }, 3500);
  })();

  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player('player', {
      height:'100%', width:'100%', videoId:'',
      host:'https://www.youtube-nocookie.com',
      playerVars:{ playsinline:1, origin: location.origin, enablejsapi:1 },
      events:{ 'onReady': onReady, 'onStateChange': onStateChange, 'onError': onError }
    });
  };

  function onReady(){
    isYTReady = true;
    statusMsg('未ロード');
    if (pendingVideoId){ try{ player.cueVideoById(pendingVideoId); }catch(e){} pendingVideoId=''; }
    updateFormatMode();
    loopUpdateCurrentTime();
    setControlsEnabled(mode==='youtube'? isYTReady : isFileReady);
  }

  function onStateChange(e){
    if (!e) return;
    if (e.data === YT.PlayerState.CUED){
      updateFormatMode();
      if (mode==='youtube') setControlsEnabled(true);
      try{
        var d = player.getVideoData && player.getVideoData();
        var vid = d && (d.video_id || d.videoId) || '';
        statusMsg(vid? ('読み込み完了: '+vid) : '読み込み完了');
      }catch(err){ statusMsg('読み込み完了'); }
      var t = $('#toggleBtn'); if (t) t.textContent = '再生';
    }
    if (e.data === YT.PlayerState.PLAYING){ var t1=$('#toggleBtn'); if (t1) t1.textContent='一時停止'; }
    if (e.data === YT.PlayerState.PAUSED || e.data === YT.PlayerState.ENDED){ var t2=$('#toggleBtn'); if (t2) t2.textContent='再生'; }
  }

  function onError(e){ statusMsg('エラー: '+(e && e.data)); }

  function ensureCueOrLoad(id, phase){
    try{
      var st = player && player.getPlayerState ? player.getPlayerState() : undefined;
      if (st===YT.PlayerState.CUED || st===YT.PlayerState.PAUSED || st===YT.PlayerState.PLAYING) return;
    }catch(e){}
    if (phase===0){
      try{ player.loadVideoById(id); }catch(e){}
      setTimeout(function(){ try{ player.pauseVideo(); }catch(e){} }, 500);
      setTimeout(function(){ ensureCueOrLoad(id,1); }, 1400);
    } else if (phase===1){
      try{ player.cueVideoById(id); }catch(e){}
    }
  }

  // ===== File mode events =====
  fileMedia.addEventListener('loadedmetadata', function(){
    isFileReady = true;
    updateFormatMode();
    if (mode==='file'){
      setControlsEnabled(true);
      var label = $('#fileName');
      statusMsg('読み込み完了: ' + (label && label.textContent ? label.textContent : 'ファイル'));
      var t = $('#toggleBtn'); if (t) t.textContent='再生';
    }
  });
  fileMedia.addEventListener('play', function(){ if (mode==='file'){ var t=$('#toggleBtn'); if(t) t.textContent='一時停止'; } });
  fileMedia.addEventListener('pause', function(){ if (mode==='file'){ var t=$('#toggleBtn'); if(t) t.textContent='再生'; } });
  fileMedia.addEventListener('ended', function(){ if (mode==='file'){ var t=$('#toggleBtn'); if(t) t.textContent='再生'; } });

  // ===== Mode switch =====
  function setMode(newMode){
    mode = newMode;
    var ytRow = $('#ytRow');
    var fileName = $('#fileName');
    var iframe = document.querySelector('#playerWrap iframe');
    if (mode==='youtube'){
      if (ytRow) ytRow.classList.remove('hidden');
      if (fileName) fileName.classList.add('hidden');
      if (iframe) iframe.style.display='';
      if (fileMedia) fileMedia.style.display='none';
      setControlsEnabled(isYTReady);
      statusMsg('未ロード');
    } else {
      if (ytRow) ytRow.classList.add('hidden');
      if (fileName) fileName.classList.remove('hidden');
      if (iframe) iframe.style.display='none';
      if (fileMedia) fileMedia.style.display='';
      setControlsEnabled(isFileReady);
      statusMsg('ファイル未選択');
    }
  }
  var radios = document.getElementsByName('mode');
  for (var i=0;i<radios.length;i++){ radios[i].addEventListener('change', function(e){ setMode(e.target.value); }); }

  // ===== UI Handlers =====
  function handleLoad(){
    try{ console.log('[UI] handleLoad clicked, mode=', mode); }catch(e){}
    if (mode!=='youtube'){
      var fi = $('#fileInput'); if (fi) fi.click();
      return;
    }
    var input = $('#videoInput');
    var raw = input ? input.value.trim() : '';
    var id = parseVideoId(raw);
    if (!id){ alert('URLまたは動画IDを入力してください'); return; }
    setControlsEnabled(false);
    statusMsg('読み込み中…');
    if (isYTReady){ try{ player.cueVideoById(id); }catch(e){} }
    else { pendingVideoId = id; }
    setTimeout(function(){ try{ ensureCueOrLoad(id,0); }catch(e){} }, 1200);
  }
  window._handleLoad = handleLoad;
  var lb = $('#loadBtn'); if (lb){ lb.addEventListener('click', handleLoad); lb.addEventListener('mousedown', handleLoad); lb.addEventListener('touchstart', handleLoad, {passive:true}); }
  var vi = $('#videoInput'); if (vi){ vi.addEventListener('keydown', function(e){ if (e.key==='Enter'){ e.preventDefault(); handleLoad(); } }); }

  var tgl = $('#toggleBtn'); if (tgl){ tgl.addEventListener('click', function(){
    if (mode==='youtube'){
      var st = player && player.getPlayerState ? player.getPlayerState() : undefined;
      if (st===YT.PlayerState.PLAYING) { try{ player.pauseVideo(); }catch(e){} }
      else { try{ player.playVideo(); }catch(e){} }
    } else {
      if (fileMedia.paused) fileMedia.play(); else fileMedia.pause();
    }
  }); }

  var addBtn = $('#addBtn'); if (addBtn){ addBtn.addEventListener('click', function(){ var t=getCurrentTime(); if(!isFinite(t)) return; stamps.push({time:t,label:''}); rebuildList(); }); }
  var copyBtn = $('#copyBtn'); if (copyBtn){ copyBtn.addEventListener('click', function(){ var txt=$('#preview').value; navigator.clipboard.writeText(txt).then(function(){ statusMsg('コピーしました'); }).catch(function(){ try{ var ta=$('#preview'); ta.focus(); ta.select(); document.getSelection().removeAllRanges(); }catch(e){} statusMsg('コピーに失敗。手動でCtrl/Cmd+Cでコピーしてください'); }); }); }
  var clrBtn = $('#clearBtn'); if (clrBtn){ clrBtn.addEventListener('click', function(){ if(!stamps.length) return; if(!confirm('すべてのタイムスタンプを削除します。よろしいですか？')) return; stamps=[]; rebuildList(); }); }

  window.addEventListener('keydown', function(e){
    var tag = (e.target.tagName||'').toLowerCase();
    if (tag==='input' || tag==='textarea') return;
    if (e.code==='Space'){
      e.preventDefault();
      if (mode==='youtube'){
        var st = player && player.getPlayerState ? player.getPlayerState() : undefined;
        if (st===YT.PlayerState.PLAYING) { try{ player.pauseVideo(); }catch(e){} }
        else { try{ player.playVideo(); }catch(e){} }
      } else {
        if (fileMedia.paused) fileMedia.play(); else fileMedia.pause();
      }
    } else if (e.key==='Enter'){
      var t = getCurrentTime(); if(!isFinite(t)) return; stamps.push({time:t,label:''}); rebuildList();
    }
  });

  function parseVideoId(input){
    if (!input) return '';
    var raw = input.trim();
    if (/^[a-zA-Z0-9_-]{10,}$/.test(raw) && raw.indexOf('http')===-1) return raw;
    try{
      var u = new URL(raw);
      var host = u.hostname.replace(/^www\./,'');
      var segs = u.pathname.split('/').filter(function(x){return x;});
      if (host.indexOf('youtu.be')!==-1 && segs[0]) return segs[0];
      var v = u.searchParams.get('v'); if (v) return v;
      if (segs[0]==='shorts' && segs[1]) return segs[1];
      if (segs[0]==='embed' && segs[1]) return segs[1];
      if (segs.length) return segs[segs.length-1];
    }catch(e){ return raw; }
    return raw;
  }

  // Init
  setMode('youtube');
})();
</script>
</body>
</html>
